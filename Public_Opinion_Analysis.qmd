---
title: "選舉民意調查資料分析報告"
date: today
author: 趙友誠 H24101060
format:
 pdf:
    engine: xelatex
    include-in-header:
      - text: |
         \usepackage{setspace,relsize}
         \usepackage{xeCJK}
         \setmainfont{Times New Roman}
         \setCJKmainfont{標楷體}
toc: TRUE
---
1. 分析所有候選人的知名度、支持度

2. 請提供3號候選人的競選策略(需在何地、對何人進行拉票)

3. 請建立3號候選人支持率的預測模式

# Brief introduction to the data

This is a complete data with no actual missing value while some might be labeled as missing.
Dimension of the Data : ***1671 samples × 15 columns***

| Variables  | Explanation     |
|:-----------|:----------------|
| V1、V2、V3 | District and Li |
| V4_1\~V4_8 | Popularity      |
| V5         | Support level   |
| V6         | Age             |
| V7         | Education level |
| V8         | Sex             |

```{r}
#| output: FALSE
#| warning: FALSE
library(haven)
library(Hmisc)
pollsav <- read_sav("poll.sav")
write.csv(pollsav, file = "poll.csv", row.names = FALSE)
pollcsv <- read.csv("poll.csv")
```

# Preprocessing

First, we replace 91,95,98,99 by 0 and then converted variables from numeric format to factor one. As the graph shown below, there is no missing value in this data.

```{r}
#| output: false
#| warning: false
pollcsv <- data.frame(
  t(apply(pollcsv,MARGIN = 1, FUN = function(row){
    row[row==99 | row==98 | row==91 | row==95] <- 0
    return(row)
  }))
)
pollcsv[] <- lapply(pollcsv, function(item) return(as.factor(item)))
n <- dim(pollcsv)[1]
```

```{r}
DataExplorer::plot_missing(pollcsv)
```

# Descriptive statistic

This chunk is for the convenience of analysis, so it will not be shown here.
```{r}
#| output: false
#| warning: false
latex(describe(pollcsv, "Public Opinion"),file = "", size = "normalsize")
```

The definition of the popularity of a candidate in this analysis is the number of appearance of a candidate that a participant answered in the 4th question. And the definition of the support level of a candidate is the number of appearance of a candidate in 5th question divided by the number of the participants who specifically choose a name in 5th question. That is, participants who did not actually answered the question are removed from the calculation.
```{r}
#| output: asis

#計算1~10號候選人在複選題出現的次數
count4 <- unlist(lapply(factor(1:10), function(x){
  return(length(unlist(apply(pollcsv[,4:11], MARGIN = 1, function(row) if(x %in% row) return (TRUE)))))
}))

#計算1~10號候選人在第5題出現的次數
count5 <- unlist(lapply(factor(0:10),function(x){
  return(sum(pollcsv$v5==x))
} ))

n_prime <- n-count5[1]
  
#知名度 = 出現次數/sample size
p <- data.frame(factor(1:10), popularity=round(count4/n,3), count4)

#支持度 = 出現次數/(sample size-沒回答的)
s <- data.frame(factor(1:10), `support level`=round(count5[2:11]/n_prime,3), count5[2:11])

#將候選人依據知名度與支持度排序
p <- p[order(p$popularity, decreasing = TRUE ),]
s <- s[order(s$support.level, decreasing = TRUE ),]

latex(data.table::data.table(cbind(p,s)),title="",file = "", booktabs = TRUE, cgroup = c('Popularity', 'Support level'), colheads = rep(c('candidate', 'rate', 'count'), 2))
```

Then we calculate the popularity and the support level grouped by district.

```{r}
#| output: asis

#依據區將資料分成Dist1與Dist2
Dist1 <-subset(pollcsv,pollcsv$v1==1)
Dist2 <-subset(pollcsv,pollcsv$v1==2)
n1 <- dim(Dist1)[1]
n2 <- dim(Dist2)[1]

#第一區的計算
#候選人在複選題出現的次數
count4_1 <- unlist(lapply(factor(1:10), function(x){
  return(length(unlist(apply(Dist1[,4:11], MARGIN = 1, function(row) if(x %in% row) return (TRUE)))))
}))
#候選人在第5題出現的次數
count5_1 <- unlist(lapply(factor(0:10),function(x){
  return(sum(Dist1$v5==x))
} ))

n1_prime <- n1-count5_1[1]

#知名度 = 出現次數/sample size
p_1 <- data.frame(factor(1:10), popularity=round(count4_1/n1,3), count4_1)

#支持度 = 出現次數/(sample size-沒回答的)
s_1 <- data.frame(factor(1:10), `support level`=round(count5_1[2:11]/n1_prime,3), count5_1[2:11])

#將候選人依據知名度與支持度排序
p_1 <- p_1[order(p_1$popularity, decreasing = TRUE ),]
s_1 <- s_1[order(s_1$support.level, decreasing = TRUE ),]

latex(data.table::data.table(cbind(p_1,s_1)),title="",file = "", booktabs = TRUE, cgroup = c('Popularity', 'Support level'), colheads = rep(c('candidate', 'rate', 'count'), 2))

#第二區的計算
#候選人在複選題出現的次數
count4_2 <- unlist(lapply(factor(1:10), function(x){
  return(length(unlist(apply(Dist2[,4:11], MARGIN = 1, function(row) if(x %in% row) return (TRUE)))))
}))

#候選人在第5題出現的次數
count5_2 <- unlist(lapply(factor(0:10),function(x){
  return(sum(Dist2$v5==x))
} ))

n2_prime <- n2-count5_2[1]

#知名度 = 出現次數/sample size
p_2 <- data.frame(factor(1:10), popularity=round(count4_2/n2,3), count4_2)

#支持度 = 出現次數/(sample size-沒回答的)
s_2 <- data.frame(factor(1:10), `support level`=round(count5_2[2:11]/n2_prime,3), count5_2[2:11])

#將候選人依據知名度與支持度排序
p_2 <- p_2[order(p_2$popularity, decreasing = TRUE ),]
s_2 <- s_2[order(s_2$support.level, decreasing = TRUE ),]

latex(data.table::data.table(cbind(p_2,s_2)),title="",file = "", booktabs = TRUE, cgroup = c('Popularity', 'Support level'), colheads = rep(c('candidate', 'rate', 'count'), 2))
```

# 候選人3的知名度與支持度(分區、年齡層、性別): 後面三個還沒做
```{r}
#1區+2區的知名度與支持度
p[1,2]
s[1,2]
#1區的知名度與支持度
p_1[1,2]
s_1[1,2]

#2區的知名度與支持度
p_2[1,2]
s_2[1,2]
```

